<html>                                                                  
 <head>      
	<title>CEPHOSLINK Project Italian study cohort</title>
	<meta charset="utf-8"> 
	<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="layout.css">
	<link rel="stylesheet" type="text/css" href="vis_layout.css">
	<link rel="stylesheet" href="jquery-ui-1.9.2.custom.min.css">
	<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="jshashtable-2.min.js"></script>
	<script type="text/javascript" src="jquery.numberformatter-1.2.3.min.js"></script>
	<script type="text/javascript" src="d3.v3.min.js"></script>
	<script type="text/javascript" src="flowShape.js"></script>
	<script type="text/javascript" src="string-operations.js"></script>
	<script type="text/javascript" src="d3.tip.min.js"></script>
	<script type="text/javascript" src="persistChart.js"></script>	
	<script type="application/javascript">    
		
		/* Constant identifiers */
		var DIMENSION_GAP = 12.0;
		var DIMENSION_LABEL_MARGIN = 30.0;
		var AGGREGATE_LABEL_MARGIN = 8.0;
		var AGGREGATE_LABEL_MIN_SIZE = 10.0;
		var AGGREGATE_LABEL_MAX_SIZE = 14.0;
		var AGGREGATE_SCALE_FACTOR = 450.0;
		var CURRENT_DIM_POS_X = 40.0;
		var FLOW_GAP = 4.0;
		var width_per_dimension = 350;
		var INTERACTION_WIDTH = 100;
		var MARGIN_TOP = 60.0;
		var current_year = 2012;
		var currDimPosX = CURRENT_DIM_POS_X;
		var current_dimension = 0;
		var min_value = -1;
		var max_value = -1;
		var load_finished;
		
		var aggregates = ["regione residenza paziente", "regione ricovero", "tipo di struttura"];
		var data; 
		var dimensions;
    	var divisionColors;
    	var category20b_sq = ['#393b79',  '#bd9e39', '#ad494a',  '#637939', '#7b4173', "#003c30","#543005", '#6b6ecf', '#e7ba52','#d6616b','#b5cf6b', '#ce6dbd','#35978f','#bf812d','#000000','#fa0019','#0000ff','#ff7c01','#08f708','#0f8ef5'];
    	//var category20b_sq = ['#000000','#fa0019','#0000ff'];
		var sum_values;
    	var formatPercentage = d3.format(".0%");
    	var formatNumber = d3.format(",");
				
		$(document).ready(function(){
			initializeFlow();
			
			//Load aggregated data
			loadAggregate();
						
			drawPersistChart();
		});  
	   


		// end persist chart
		
		function refresh()
		{
			if(load_finished)
			{
				loadingFinished(false);
				clearSVGCanvas();
				loadAggregate();
			}
		}
	   
		function drawDimension(aggregated_data, dimension) {
			"use strict";
		
			var sumValue = sumDimension(aggregated_data);
						
			var currPosY = MARGIN_TOP;
			var currPosLabelY = MARGIN_TOP;
						
			d3.select('.svg_canvas')
				.append('g')
				.attr('class', 'dimension_group')
				.selectAll('.dimension_line')
				.data(aggregated_data)
				.enter()
				.append('path')
				.attr('class', 'dimension_line')
				.attr('dim_axis', dimension)
				.attr('x', currDimPosX)
				.attr('height', function(aggregate){
					return (parseFloat(aggregate.value)/sumValue) * AGGREGATE_SCALE_FACTOR;
				})
				.attr('id', function(aggregate){
					return StringOperations.buildID(aggregate.dimension); 
				})
				.attr('d', function(aggregate)
				{

					var posY = (parseFloat(aggregate.value)/sumValue) * AGGREGATE_SCALE_FACTOR;
										
					var path_data = "M " + currDimPosX + " " + currPosY + " L " + currDimPosX + " " + (currPosY + posY);
					
					d3.select(this).attr('y', currPosY);
					d3.select(this).attr('dimValue', aggregate.value);
					currPosY += posY + DIMENSION_GAP;
										
					return path_data;
				})
				.style('stroke-opacity', 0.0)
				.style("stroke", function(d) {
				        return d.color = divisionColors(d.dimension.substring(1, d.dimension.length));})
				.transition()
				.duration(500)
				.style('stroke-opacity', 0.75);
						
			addDimensionLabels(dimension, currDimPosX);
			
			currDimPosX += width_per_dimension;
			
			current_dimension += 1;
			
			if(current_dimension < aggregates.length)
			{			
				loadAggregate();
			}
			else
			{
				current_dimension = 0;
				currDimPosX = CURRENT_DIM_POS_X;
				loadFlows();
			}
		
	   }
		function loadAggregate()
		{
			d3.json("agg_sum4.json", function(error, json) {
			  if (error) return console.warn(error);
			  data = json;
			  var aggregates = d3.nest().key(function(d) {return d.aggregate;}).entries(data);

			  dimensions = d3.nest().key(function(d) {return d.dimension.substring(1, d.dimension.length);}).entries(data).map(function (d) {return d.key;});
			  // divisionColors = d3.scale.category20b().domain(dimensions);
			  divisionColors = d3.scale.ordinal().domain(dimensions).range(category20b_sq);
			  drawDimension(aggregates[current_dimension].values, aggregates[current_dimension].key);

			  });
		}
		
		function addDimensionLabels(dimension, currDimPosX)
		{
			//Add labels of the dimension
			d3.select('.svg_canvas')
				.append('text')
				.text(dimension.toUpperCase())
				.attr('class', 'dimension_header')
				.attr('x', function() { return currDimPosX;} )
				.attr('y', DIMENSION_LABEL_MARGIN)
				.style('fill-opacity', 0.0)
				.transition()
				.duration(2500)
				.style('fill-opacity', 1.0);
		}
		
		function addAggregateLabels()
		{
			var svg_canvas = d3.select('.svg_canvas');
			d3.selectAll('.dimension_line').each(function(aggregate)
			{
				var dim_line = d3.select(this);
				
				svg_canvas.append('text')
				.text(aggregate.dimension.substring(1,aggregate.dimension.length).replace(" and ", "&"))
				.attr('id', (aggregate.dimension))
				.attr('class', 'aggregate_label')
				.attr('x', parseFloat(dim_line.attr('x')) + AGGREGATE_LABEL_MARGIN)
				.attr('y', parseFloat(dim_line.attr('y')) + (parseFloat(dim_line.attr('height')) / 2.0))
				.style('font-size', function()
				{				
					if(parseFloat(dim_line.attr('height')) < 10.0)
					{
						return Math.max(AGGREGATE_LABEL_MIN_SIZE, parseFloat(dim_line.attr('height')));
					}
					else
					{
						return AGGREGATE_LABEL_MAX_SIZE;
					}
				})
				.style('fill-opacity', 0.0)
				.transition()
				.duration(2500)
				.style('fill-opacity', 1.0);
			});				
		}
		
		function loadFlows()
		{
			d3.json("test2-csv.json", function(error, json) {
			  if (error) return console.warn(error);
			  data = json;
			  
			  drawFlows(data);

			  });
		}
				
		function initializeFlow()
		{
			var svg_width = $('body').width() - $('#navigation').width() - (CURRENT_DIM_POS_X * 2.0) - 100;
			
			d3.select('#content')
				.append('svg')
				.attr('class', 'svg_canvas')
				.attr('width', svg_width);
			
			width_per_dimension = (svg_width / (aggregates.length - .5)) - CURRENT_DIM_POS_X;
		}
	   
		function drawFlows(raw_flow_data)
		{
			d3.select('.svg_canvas')
				.selectAll('.flow_line')
				.data(raw_flow_data)
				.enter()
				.append('path')
				.attr('class', 'flow_line')
				.attr('d', function(flow_line)
				{	
					var value = parseFloat(flow_line.value);
				
					if(value > 0.0)
					{
						var path_data = "";
						
						for(var i = 0; i < aggregates.length - 1; i++)
						{
							var dimAxisFrom = d3.select("#" + StringOperations.buildID(flow_line[aggregates[i]]));
							var dimAxisTo = d3.select("#" + StringOperations.buildID(flow_line[aggregates[i + 1]]));
							
							var startHeight = (value / parseFloat(dimAxisFrom.attr('dimValue'))) * parseFloat(dimAxisFrom.attr('height'));
							var endHeight = (value / parseFloat(dimAxisTo.attr('dimValue'))) * parseFloat(dimAxisTo.attr('height'));
														
							var startX = parseFloat(dimAxisFrom.attr('x'));
							var startY;
							
							if(dimAxisFrom.attr('currPosY') == null)
								startY = parseFloat(dimAxisFrom.attr('y'));
							else
								startY = parseFloat(dimAxisFrom.attr('currPosY'));
							
							dimAxisFrom.attr('currPosY', startY + startHeight);
							
							
							var endX = parseFloat(dimAxisTo.attr('x'));
							var endY;
							
							if(dimAxisTo.attr('currPosY') == null)
								endY = parseFloat(dimAxisTo.attr('y'));
							else
								endY = parseFloat(dimAxisTo.attr('currPosY'));
							
							
							if(i == aggregates.length - 2)
								dimAxisTo.attr('currPosY', endY + endHeight);
							
							var flowShape = new FlowShape(startX + FLOW_GAP, startY, endX - FLOW_GAP, endY, startHeight, endHeight);
							path_data += " " + flowShape.getPathData();
						}
						
						return path_data; 
					}
					// else
					// {
					// 	return "";
					// }
						
				});


			// tooltips : show tooltips only for links that are highlighted.
			// NOTE: turns out this doesn't make much UI sense; the flows are way too small for tooltips to really show up very easily
      		// var linkTip = d3.tip()
	       //      .attr('class', 'd3-tip')
	       //      .offset([-10, 50])
	       //      .html(function(d) { return d3.select(this).attr("class") === "flow_line_highlighted" ? "<span style='color:#ef8a62'>"  + d.value + "</span> " : "";});


	      //set up the tool tips
	      // d3.selectAll(".flow_line").call(linkTip);
	      //           d3.selectAll(".flow_line").on('mouseover', linkTip.show)
	      //               .on('mouseout', linkTip.hide);
			
			addAggregateLabels();
			drawInteractionShapes();
			loadingFinished(true);
		}
				
		function drawInteractionShapes()
		{
			var svg_canvas = d3.select('.svg_canvas');
			d3.selectAll(".dimension_line").each(function()
			{
				svg_canvas.append('rect')
				.data(d3.select(this).data())
				.attr('dim_axis', d3.select(this).attr('dim_axis'))
				.attr('x', d3.select(this).attr('x') - (INTERACTION_WIDTH / 2.0))
				.attr('y', d3.select(this).attr('y'))
				.attr('width', INTERACTION_WIDTH)
				.attr('height', d3.select(this).attr('height'))
				.attr('class', 'interaction_shape')
				.on('mouseover', highlightNode)
				.on('mouseout', unhighlightNode)
				.on('click', highlightFlows);
			});

		}	
		
		function highlightNode() {
			var dim = d3.select(this).data()[0].dimension;
			var dim_axis = d3.select(this).attr('dim_axis');
			
			d3.selectAll('.dimension_line').filter(function(d) {return d.dimension == dim;}).style("stroke-opacity",0.50);
			// d3.selectAll('.aggregate_label,id=' + dim + '"').style("font-color","steelblue");
		}

		function unhighlightNode() {
			var dim = d3.select(this).data()[0].dimension;
			
			d3.selectAll('.dimension_line').filter(function(d) {return d.dimension == dim;}).style("stroke-opacity",0.85);
		}


		function clearSVGCanvas()
		{
			d3.selectAll('.flow_line_highlighted').remove();
			d3.selectAll('.flow_line').remove();
			d3.selectAll('.flow_line_hide').remove();
			d3.selectAll('.dimension_group').remove();
			d3.selectAll('.dimension_line').remove();
			d3.selectAll('.interaction_shape').remove();
			d3.selectAll('.aggregate_label').remove();
			d3.selectAll('.value_label').remove();
			d3.selectAll('.dimension_header').remove();
		}
		
		/*-------------*/
		/* Interaction */
		/*-------------*/
		
		function highlightFlows()
		{
			var dim = d3.select(this).data()[0].dimension;
			var dim_axis = d3.select(this).attr('dim_axis');
			
			deselectFlows();
				
			d3.selectAll('.flow_line')
			.attr('class', function(flow_data)
			{
				if(flow_data[dim_axis] == dim)
					return 'flow_line_highlighted';	
				else
					return 'flow_line_hide';
			});	

			showValues();
			//showCommentary(dim);
		}
		
		function deselectFlows()
		{
			d3.selectAll('.flow_line_highlighted')		
			.attr('class', 'flow_line');
			
			d3.selectAll('.flow_line_hide')		
			.attr('class', 'flow_line');
			d3.selectAll('.value_label').remove();
		}
		
		function showValues()
		{
			var highlighted_flows = d3.selectAll('.flow_line_highlighted');
				
			sum_values = new Array();
			for(var i = 0; i < aggregates.length; i++)
			{
				sum_values[i] = new Object();
			}
			
			if(!highlighted_flows.empty())
			{					
				highlighted_flows.each(function(flow_data){
					for(var i = 0; i < aggregates.length; i++)
					{
						var dim = flow_data[aggregates[i]];
						
						if(sum_values[i][dim] == undefined)
						{
							sum_values[i][dim] = parseFloat(flow_data.value);
						}
						else
						{
							sum_values[i][dim] += parseFloat(flow_data.value);
						}
					}			
				});
			}
			else
			{
				d3.selectAll('.flow_line').each(function(flow_data){
					for(var i = 0; i < aggregates.length; i++)
					{
						var dim = flow_data[aggregates[i]];
						
						if(sum_values[i][dim] == undefined)
						{
							sum_values[i][dim] = parseFloat(flow_data.value);
						}
						else
						{
							sum_values[i][dim] += parseFloat(flow_data.value);
						}
					}			
				});
			}

			if(showNumberCheckbox.checked)
				{
				
				var svg_canvas = d3.select('.svg_canvas');
				
				d3.selectAll('.dimension_line').each(function(aggregate)
				{
					var dim_line = d3.select(this);
					
					svg_canvas.append('text')
					.text(function()
					{
						var value = sum_values[jQuery.inArray(dim_line.attr('dim_axis'), aggregates)][aggregate.dimension];
						
						if(value == undefined)
							return "";
						else
							return $.formatNumber(value, {format:"#,###", locale:"us"});
					})
					.attr('class', 'value_label')
					.attr('x', parseFloat(dim_line.attr('x')) - AGGREGATE_LABEL_MARGIN)
					.attr('y', parseFloat(dim_line.attr('y')) + (parseFloat(dim_line.attr('height')) / 2.0))
					.style('font-size', function()
					{				
						if(parseFloat(dim_line.attr('height')) < 10.0)
						{
							return Math.max(AGGREGATE_LABEL_MIN_SIZE, parseFloat(dim_line.attr('height')));
						}
						else
						{
							return AGGREGATE_LABEL_MAX_SIZE;
						}
					})
					.style('fill-opacity', 0.0)
					.transition()
					.duration(2500)
					.style('fill-opacity', 1.0);
				});				
			}
			else			
			{
				d3.selectAll('.value_label').remove();
			}
		}
		
		function sumDimension(dimension)
		{
			var totalValue = 0.0;
			
			$.each(dimension, function(index, property)
			{
				totalValue += parseFloat(property.value);
			});
		
			return totalValue;
		}




		
		
		
		function loadingFinished(ready)
		{
			load_finished = ready;
		}
				
		function getOverview()
		{
			deselectFlows();
			showValues();
			//showCommentary(null);
		}
		
		function  dispatchBar() {
			console.log(this.__data__.college);
			var bar_dim = this.__data__.college;	

			// super huge thanks to Mike Bostock and his example for how to do this: http://bl.ocks.org/mbostock/4679202		
			var shape = d3.selectAll(".interaction_shape").filter(function (d) {return d.dimension == bar_dim;}).each(highlightFlows);
		}
		
	</script>                                                               
 </head>                                                                 
 <body>
		
	<div id="navigation">
		<h1>2012-2013 CephosLink project - Italian study Cohort</h1>
		<h2>psychiatric hospital discharge migrations in Italy Regions.......</h2>
		
		<!-- <button class="overviewbutton" onclick="getOverview()">Reload</button> -->
		<div class="box">	
			<div class="checkboxText">Show numbers of psychiatric hospitalizations: </div>		
			<input id="showNumberCheckbox" type="checkbox" onClick="showValues()" value='TRUE' >
		</div>
		
	
	</div>
	<div>
		<div id="content" ></div>

	</div>
 </body>                                                                 
 </html>
